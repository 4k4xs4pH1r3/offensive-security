# Set the execution policy to RemoteSigned for the local machine
Set-ExecutionPolicy RemoteSigned -Force

# Set the download URL for the latest NuGet executable
$nugetUrl = "https://dist.nuget.org/win-x86-commandline/latest/nuget.exe"

# Set the desired installation directory for NuGet
$nugetInstallDir = "$env:ProgramFiles\NuGet"

# Create the NuGet installation directory if it doesn't exist
if (!(Test-Path $nugetInstallDir)) {
  New-Item -ItemType Directory -Path $nugetInstallDir | Out-Null
}

# Download the NuGet executable
try {
  Invoke-WebRequest -Uri $nugetUrl -OutFile "$nugetInstallDir\nuget.exe"
}
catch {
  Write-Warning "Failed to download NuGet.exe. Please check your internet connection and try again."
}

# Add the NuGet installation directory to the system PATH environment variable
[Environment]::SetEnvironmentVariable("Path", "$env:Path;$nugetInstallDir", "Machine")

# Download the dotnet-install.ps1 script
$dotnetInstallScriptUrl = "https://dotnet.microsoft.com/download/dotnet/scripts/v1/dotnet-install.ps1"

try {
  Invoke-WebRequest -Uri $dotnetInstallScriptUrl -OutFile ".\dotnet-install.ps1"

  # Run the dotnet-install.ps1 script to install the latest .NET SDK
  .\dotnet-install.ps1 -Channel STS
}
catch {
  Write-Warning "Failed to download or execute dotnet-install.ps1. Please check your internet connection and try again."
}

# Display success messages (or warnings if downloads failed)
if (Test-Path "$nugetInstallDir\nuget.exe") {
  Write-Host "NuGet installed successfully!"
}

if (Test-Path "C:\Program Files\dotnet\dotnet.exe") {
  Write-Host ".NET SDK installed successfully!"
}
