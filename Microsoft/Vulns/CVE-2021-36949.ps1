# Disable NTLM for Azure AD Connect

# Update the Provisioning Agent to the latest version
# Download the latest agent from the official Microsoft website and install it

# Create the registry key (if it doesn't exist)
if (!(Test-Path "HKLM:\SOFTWARE\Microsoft\Azure AD Connect Provisioning Agent")) {
  New-Item -Path "HKLM:\SOFTWARE\Microsoft\Azure AD Connect Provisioning Agent" -Force
}

# Get current value of DisableNTLMAuth (if it exists)
$CurrentValue = Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Azure AD Connect Provisioning Agent" -Name "DisableNTLMAuth" -ErrorAction SilentlyContinue

if ($CurrentValue) {
  Write-Host "Current DisableNTLMAuth value: $($CurrentValue.DisableNTLMAuth)"
} else {
  Write-Host "DisableNTLMAuth value not found. It will be created and set to 1."
}

# Set the DisableNTLMAuth value
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Azure AD Connect Provisioning Agent" -Name "DisableNTLMAuth" -Value 1 -Type DWord

# Restart the service
Restart-Service "Microsoft Azure AD Connect Provisioning Agent"

# Verify the change
$NTLMDisabled = Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Azure AD Connect Provisioning Agent" -Name "DisableNTLMAuth"

if ($NTLMDisabled.DisableNTLMAuth -eq 1) {
  Write-Host "NTLM authentication successfully disabled for Azure AD Connect Provisioning Agent."
} else {
  Write-Host "Failed to disable NTLM authentication for Azure AD Connect Provisioning Agent. Please check the configuration."
}

# Disable NTLM authentication for Azure AD Connect (if applicable)
# For Azure AD Connect, ensure you are using the latest version and refer to the official documentation for specific instructions on disabling NTLM:
# * Prerequisites for Azure AD Connect: [https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-install-prerequisites](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-install-prerequisites)
